CREATE DEFINER=`root`@`localhost` PROCEDURE `PA_INSERTAR_TRANSACCIONAL`(IN PIDCUENTAORIGEN INT, IN PIDCUENTADESTINO INT,IN PVALOR DECIMAL(10,2))
BEGIN
DECLARE saldo_actual_o DECIMAL(10,2);
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN 
ROLLBACK;
END;
START TRANSACTION;
SELECT SALDO INTO saldo_actual_o
FROM CUENTA WHERE IDCUENTA = PIDCUENTAORIGEN FOR UPDATE;
iF saldo_actual_o >= PVALOR THEN
UPDATE CUENTA SET SALDO = SALDO - PVALOR WHERE IDCUENTA=PIDCUENTAORIGEN;
UPDATE CUENTA SET SALDO = SALDO + PVALOR WHERE IDCUENTA=PIDCUENTADESTINO;
INSERT INTO TRANSFERENCIA 
        VALUES (PIDCUENTAORIGEN, PIDCUENTADESTINO, PVALOR);
INSERT INTO MOVIMIENTO (IDCUENTA, TIPOMOVIMIENTO, VALOR)
        VALUES (PIDCUENTADESTINO, 'A', PVALOR);
INSERT INTO MOVIMIENTO (IDCUENTA, TIPOMOVIMIENTO, VALOR)
        VALUES (PIDCUENTAORIGEN, 'D', PVALOR);
SELECT 'La transferencia se realizo con exito' AS resultado;
ELSE
SELECT 'Saldo insuficiente para realizar la transferencia' AS resultado;
END IF;
COMMIT;
END
